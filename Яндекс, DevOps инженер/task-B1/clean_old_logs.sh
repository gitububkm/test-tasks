#!/bin/bash

# Функция для вывода справки
show_help() {
    echo "Использование: $0 <путь_к_директории> <количество_дней>"
    echo ""
    echo "Описание:"
    echo "  Находит и удаляет файлы с расширением .log, которые старше указанного количества дней"
    echo ""
    echo "Аргументы:"
    echo "  путь_к_директории  - путь к директории для поиска лог-файлов"
    echo "  количество_дней    - файлы старше этого количества дней будут найдены"
    echo ""
    echo "Пример:"
    echo "  $0 /var/log 30"
    echo "  (найдет все .log файлы в /var/log старше 30 дней)"
}

# Проверка количества аргументов
if [ $# -ne 2 ]; then
    echo "Ошибка: Неверное количество аргументов"
    echo ""
    show_help
    exit 1
fi

# Сохраняем аргументы в переменные
LOG_DIR="$1"
DAYS="$2"

# Проверка существования директории
if [ ! -d "$LOG_DIR" ]; then
    echo "Ошибка: Директория '$LOG_DIR' не существует"
    exit 1
fi

# Проверка, что DAYS - это число
if ! [[ "$DAYS" =~ ^[0-9]+$ ]]; then
    echo "Ошибка: '$DAYS' не является числом"
    exit 1
fi

# Поиск файлов старше N дней и сохранение в переменную
# find - ищет файлы
# "$LOG_DIR" - директория для поиска
# -type f - только файлы (не директории)
# -name "*.log" - имя файла должно заканчиваться на .log
# -mtime +$DAYS - файлы, измененные более N дней назад (mtime = modification time)
OLD_LOGS=$(find "$LOG_DIR" -type f -name "*.log" -mtime +$DAYS 2>/dev/null)

# Проверка, найдены ли файлы
if [ -z "$OLD_LOGS" ]; then
    echo "Файлы с расширением .log старше $DAYS дней не найдены в директории '$LOG_DIR'"
    exit 0
fi

# Вывод списка найденных файлов
echo "Найдены следующие файлы старше $DAYS дней:"
echo "$OLD_LOGS"

# Запрос подтверждения
echo -n "Удалить эти файлы? (y/n): "
read -r CONFIRM

# Проверка ответа пользователя
if [ "$CONFIRM" = "y" ] || [ "$CONFIRM" = "Y" ]; then
    # Удаление файлов
    echo "$OLD_LOGS" | while read -r file; do
        if [ -f "$file" ]; then
            rm "$file"
            echo "Удален: $file"
        fi
    done
    echo "Готово! Файлы удалены."
elif [ "$CONFIRM" = "n" ] || [ "$CONFIRM" = "N" ]; then
    echo "Операция отменена. Файлы не удалены."
    exit 0
else
    echo "Неверный ответ. Используйте 'y' или 'n'. Операция отменена."
    exit 1
fi